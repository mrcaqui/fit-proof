- `適用開始`について、複数設定した場合の期間重複時のロジックを決めたい。`submission_items`と`submission_rules`の`created_at`で管理しているが、新たに`effective_at`列を追加したい。初回作成時`created_at`と`effective_at`は同時刻とする。管理者が`適用開始`を操作すると`created_at`ではなく`effective_at`を変更することとする。設定した内容により期間重複があり矛盾が生じた場合は、`created_at`が新しいものを優先することで矛盾解決とする
- 「土日どちらかで1回動画アップ」などどちらか1日だけを対象とする機能を実装したい。それに伴い`投稿対象日の設定`を`目標日の設定`としてロジックを刷新したい:
  - 休息日の指定: 曜日指定で「1週間のうち、指定した日は動画のアップ不要」という日を管理者が指定。指定後のカードは曜日ごとに分けなくても、「水曜と木曜は休息日」という1つのカードで良い
  - グループの指定: 曜日指定で「この日とこの日のうち、◯日動画アップすればOK」という指定。「土日のうち1日」や「月水金で2日」など柔軟にグループ分け対応したい
  - 最終的に設定した値をベースに判断して「週◯日が目標」として`目標日の設定`UI上にも、ClientのCalendar UI上にも目標日数を表示したい
- 動画プレイヤーの再生速度を5倍まで対応にしたい。1.5、2.5など細かいのは不要なので1x、2x、3x、4x、5xのみでOK
- ストレート達成条件修正:
  - 達成の判断は1週間単位で固定
  - `目標日の設定`で指定された目標日数を達成しなければならないか、それ以下でも良いかの設定。目標日数以下で良いとする場合、管理者が日数を指定する
  - リバイバルを許容するかのToggle: 有効ならリバイバルがあってもストレート達成条件を満たしたものとする
  - シールドを許容するかのToggle: 有効ならシールドがあってもストレート達成条件を満たしたものとする
- シールドは任意のタイミングで使えるようにする。管理者が設定した`カレンダー投稿制限`の範囲でClientが自由に適用する日を指定できるようにしたい
- ストレート達成は管理者が設定した`カレンダー投稿制限`の過去の投稿が不可になった時点で計算。こうすることでリバイバルやシールドはもう適用できない=結果として確定となりシンプルなロジックになることを期待
- 当日投稿して翌日に管理者が承認したらどうなる？テストとして昨日(2/22)の日付の動画を投稿→`submissions`の`created_at`を一日戻した(当日に投稿したように見せる)→管理者が本日(2/23)承認するとリバイバル扱いになった。投稿日の提出期限以内に投稿したのであればリバイバルではなく正しく投稿した扱いにしたい。リバイバルを`submissions`の`created_at`をベースに判断すればシンプルになると思われる
- 提出期限が設定されている場合、過去の投稿は全て期限切れ扱い(`submissions`テーブルの`is_late`=TRUE)にしたい
- CloudflareR2への保存が、10GBで確実に収まるような実装になっているか確認
- `連続日数`のTooltip説明でストレート達成の説明があり、`ストレート達成`項目と重複しているので削除
- `リバイバル`のTooltip説明で、`ストリーク`という言葉が分かり辛いので、`連続日数`に変更
- `提出期限の設定`の`期限の動作設定`について、`期限を厳守（ブロック）`が`過去の投稿を許可`と矛盾しており不要だと気づきました。`期限の動作設定`は`submissions`テーブルの`is_late`をベースに「期限超過」マークをClientに見せるか見せないかを設定できるだけでOKです。期限を過ぎても投稿は可能とします。可能な期間は`過去の投稿を許可`で操作できるのでそちらでOKです。

- シールドを適用したら、カレンダーの日付セルにスタンプと同じように大きくシールドアイコンを表示してほしい。現在左上に小さく表示なので適用したことが分かりづらい
- シールド適用後は「シールド適用中」の下に「シールドを取り消す」ボタンが表示されるが、わざわざ下にボタンを作って無駄にスペースを表示したくないので、「シールド適用中」の右上に取り消しボタンを表示するようにしたい
- シールド適用すると連続日数がカウントされるのでカウントしないようにしてほしい。累積記録はカウントされないので期待通りで、「実際にトレーニングを行ったわけではない(動画投稿が無い)が、連続日数のカウントは0にリセットしない」というだけの配慮なので、トレーニングを実施したかのように連続日数を増やす必要はありません。

- 管理者が設定した目標日数の具体的な日数をストレートのTooltip説明に表示したい。「目標日数(4日)」など。
- 「目標日の設定」のグループの「そのうちx日でよい」設定について、数値をBackspaceなどで削除しようとすると0になり、0自体は消せない。またデスクトップでの表示では増減ボタンがあるが、押しても数値が変わらず動作していない。モバイルでは増減ボタンが無い。

以下についてシンプルな実装にするためにどういうものが考えられるか提案して。

### 懸念点

- 「目標日の設定」で設定したグループや休息日を削除した際に、過去のものにも影響して連続日数やストレートが途切れてしまうことに気づいた。「投稿項目の設定」や「提出期限の設定」でも同じような過去への影響が出てくると懸念
- 以前、論理削除(deleted_at)により「変更は過去には影響しない」よう実装していたが、管理が煩雑になるのと過去が全く変更できないという動作確認上の不都合もあったので削除してしまったが、やはりそちらの方が良いのか決めかねている。論理削除にするとDB(Supabase)上には項目が残るため、何度も追加や削除しているうちにエントリが膨大になってしまい煩雑になることも懸念される。

### 要望

- 本番運用では基本的に過去の内容は変更しなくても良い
- ただし、`過去の投稿を許可`の範囲においては変更できるようにもしたい

#### 案

- やはり`deleted_at`による論理削除を再実装する
- UIからの削除時は`deleted_at`を記録して、DB上には保持しておく
- `deleted_at`より前の日付についてはUI上削除しても変更しないよう、現在のコードを修正
- 再度項目追加した際、同じ設定であればDB上項目を追加せず既存項目の`created_at`を修正する。これで同じようなエントリ項目が増えることを抑制できる期待。何を根拠に「同じ設定」であると判断するのかは各項目ごとに検討が必要
- 現在の実装は`effective_from`が存在するため、UIで適用開始の日付を操作することで過去にも影響を与えられるようにする

- 案Aが良いですが、誤って当日に何度も追加削除してしまった場合に、どれを最終的にActiveにするかは`effective_to = today`の`today`という表記で判断できる？`effective_to IS NULL`でかつ`effective_from = today`のものが最終的な反映スべきものとしてある特定の1つを認識できるんですかね？`effective_from`が今日でなく過去の日付に変更された時も対応できますか？
- UIとしては`effective_to`を適用したいカードが作成される、該当の`投稿項目の設定`、`提出期限の設定`、`目標日の設定`に「削除済」のようなトグルを作成、デフォルト未開閉としておくことで必要に応じて変更できるようにするのはいかがでしょうか。
- 「削除済」にもアクティブな項目と同じようなカードを列挙しつつ、「適用開始」と同じようなUIにて追加で`effective_to`を意味する「適用終了」を追加して設定させるというイメージです。
- 多数の項目が表示されることも想定されるので、「削除済」で表示されるカードは小さなものが良いです。カードの記載を1行で収めるか、そもそも表形式にしてしまうなどでも良いと思います。
